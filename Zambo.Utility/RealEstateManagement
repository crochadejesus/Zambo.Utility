public PagedList<RealEstateInformationResponse> GetAssets(RealEstateSearchFilters searchFilters)
        {
            try
            {
                using (var model = new ValueModel())
                {
                    var returnList = new PagedList<RealEstateInformationResponse>();

                    var assetQuery = model.Asset.Where(x => x.IsActive).AsQueryable();
                    if (assetQuery.Any())
                    {
                        var realEstateQuery = model.RealEstate.AsQueryable();

                        assetQuery = searchFilters.IsHighlighted.HasValue ? assetQuery.Where(x => x.IsHighlighted == searchFilters.IsHighlighted.Value) : assetQuery;
                        assetQuery = searchFilters.MaxPrice.HasValue ? assetQuery.Where(x => x.CurrentPrice <= searchFilters.MaxPrice.Value) : assetQuery;
                        assetQuery = searchFilters.MinPrice.HasValue ? assetQuery.Where(x => x.CurrentPrice >= searchFilters.MinPrice.Value) : assetQuery;
                        assetQuery = !string.IsNullOrWhiteSpace(searchFilters.Reference) ? assetQuery.Where(x => x.Reference == searchFilters.Reference) : assetQuery;
                        assetQuery = searchFilters.PriceReduced.HasValue ? assetQuery.Where(x => x.PreviousPrice > x.CurrentPrice) : assetQuery;

                        realEstateQuery = searchFilters.HasParking.HasValue ? realEstateQuery.Where(x => x.HasParking == searchFilters.HasParking.Value) : realEstateQuery;
                        realEstateQuery = searchFilters.MinConstructionYear.HasValue ? realEstateQuery.Where(x => x.ConstructionYear >= searchFilters.MinConstructionYear.Value) : realEstateQuery;
                        realEstateQuery = searchFilters.MaxConstructionYear.HasValue ? realEstateQuery.Where(x => x.ConstructionYear <= searchFilters.MaxConstructionYear.Value) : realEstateQuery;

                        realEstateQuery = searchFilters.Parish.HasValue ? realEstateQuery.Where(x => x.ParishID == searchFilters.Parish.Value) : realEstateQuery;
                        realEstateQuery = searchFilters.County.HasValue ? realEstateQuery.Where(x => x.CountyID == searchFilters.County.Value) : realEstateQuery;
                        realEstateQuery = searchFilters.District.HasValue ? realEstateQuery.Where(x => x.DistrictID == searchFilters.District.Value) : realEstateQuery;

                        realEstateQuery = searchFilters.MaxArea.HasValue ? realEstateQuery.Where(x => x.GrossBuildingArea <= searchFilters.MaxArea.Value) : realEstateQuery;
                        realEstateQuery = searchFilters.MinArea.HasValue ? realEstateQuery.Where(x => x.GrossBuildingArea >= searchFilters.MinArea.Value) : realEstateQuery;

                        realEstateQuery = searchFilters.MaxTipology.HasValue ? realEstateQuery.Where(x => x.RealEstateTipologyID <= searchFilters.MaxTipology.Value) : realEstateQuery;
                        realEstateQuery = searchFilters.MinTipology.HasValue ? realEstateQuery.Where(x => x.RealEstateTipologyID >= searchFilters.MinTipology.Value) : realEstateQuery;
                        realEstateQuery = searchFilters.PropertyCondition.HasValue ? realEstateQuery.Where(x => x.RealEstateConditionID == searchFilters.PropertyCondition.Value) : realEstateQuery;

                        realEstateQuery = searchFilters.PropertyType.HasValue ? realEstateQuery.Where(x => x.RealEstateTypeID == searchFilters.PropertyType.Value) : realEstateQuery;
                        realEstateQuery = searchFilters.StatusId.HasValue ? realEstateQuery.Where(x => x.RealEstateStatusID == searchFilters.StatusId.Value) : realEstateQuery;

                        var orderField = string.Empty;

                        switch (searchFilters.SortBy)
                        {
                            case SortBy.PriceIncreasing:
                                orderField += "CurrentPrice asc,";
                                break;
                            case SortBy.PriceDecreasing:
                                orderField += "CurrentPrice desc,";
                                break;
                            case SortBy.AreaIncreasing:
                                orderField += "GrossBuildingArea asc,";
                                break;
                            case SortBy.AreaDecreasing:
                                orderField += "GrossBuildingArea desc,";
                                break;
                            case SortBy.MostViewed:
                                orderField += "HitCount desc,";
                                break;
                            default:
                                break;
                        }

                        if (searchFilters.MostRecentOptions.HasValue)
                        {
                            var date = DateTime.Now;
                            switch (searchFilters.MostRecentOptions)
                            {
                                case MostRecentOptions.Last15Days:
                                    date = date.AddDays(-15);
                                    assetQuery = assetQuery.Where(x => x.PublishDate >= date);
                                    break;
                                case MostRecentOptions.Last30Days:
                                    date = date.AddDays(-30);
                                    assetQuery = assetQuery.Where(x => x.PublishDate >= date);
                                    break;
                                case MostRecentOptions.Last2Months:
                                    date = date.AddMonths(-2);
                                    assetQuery = assetQuery.Where(x => x.PublishDate >= date);
                                    break;       
                                default:
                                    break;
                            }
                        }

                        orderField += "PublishedDate desc";

                        IQueryable<RealEstateInformationResponse> mergedResults = GetMergedResults(assetQuery, realEstateQuery, model, searchFilters.LanguageId);

                        if (searchFilters.RandomSort.GetValueOrDefault())
                        {
                            mergedResults = mergedResults.OrderBy(q => Guid.NewGuid());
                        }
                        else
                        {
                            mergedResults = mergedResults.OrderBy(orderField);
                        }

                        var realEstateList = mergedResults.Skip((searchFilters.PageNumber - 1) * searchFilters.PageSize).ToList().Take(searchFilters.PageSize).ToList();

                        returnList = new PagedList<RealEstateInformationResponse>();
                        returnList.Rows = realEstateList;
                        returnList.TotalRows = mergedResults.Count();
                        returnList.PageNumber = searchFilters.PageNumber;
                        returnList.PageSize = searchFilters.PageSize;
                    }
                    return returnList;
                }
            }
            catch (Exception ex)
            {
                _log.ErrorFormat("An Error Occured : {0} - Inner exception - {1}", ex.Message, ex.InnerException);
                throw;
            }
        }
        
        private static IQueryable<RealEstateInformationResponse> GetMergedResults(IQueryable<Asset> assetQuery, IQueryable<RealEstate> realEstateQuery, ValueModel model, int languageId)
        {
            IQueryable<RealEstateInformationResponse> mergedResults;

                mergedResults = (from a in assetQuery
                                 join r in realEstateQuery on a.AssetID equals r.AssetID
                                 join rc in model.RealEstateConditionLocalized on r.RealEstateConditionID equals rc.RealEstateConditionID
                                 from rt in model.RealEstateTipologyLocalized
                                    .Where(x=>x.RealEstateTipologyID == r.RealEstateTipologyID && x.LanguageID == languageId)
                                    .DefaultIfEmpty()
                                 from cpu in model.AssetDocument
                                 .Where(x => x.AssetID == a.AssetID && x.DocumentTypeID == 1 && x.IsActive)
                                 .DefaultIfEmpty()
                                 from plant in model.AssetDocument
                                 .Where(x => x.AssetID == a.AssetID && x.DocumentTypeID == 2 && x.IsActive)
                                 .DefaultIfEmpty()
                                 join rs in model.RealEstateStatusLocalized on r.RealEstateStatusID equals rs.RealEstateStatusID
                                 join rType in model.RealEstateTypeLocalized on r.RealEstateTypeID equals rType.RealEstateTypeID
                                 from photo in model.AssetPhoto
                                 .Where(x=>x.AssetID == a.AssetID && x.IsActive && x.IsHighlighted)
                                 .DefaultIfEmpty()
                                 where rc.LanguageID == languageId 
                                 && rs.LanguageID == languageId
                                 && rType.LanguageID == languageId
                                 select new RealEstateInformationResponse
                                 {
                                     AssetID = a.AssetID,
                                     AssetTypeID = r.RealEstateTypeID,
                                     ConstructionYear = r.ConstructionYear,
                                     County = r.County.Description,
                                     CountyID = r.CountyID,
                                     CurrentPrice = a.CurrentPrice,
                                     Description = a.Description,
                                     District = r.District.Description,
                                     DistrictID = r.DistrictID,
                                     GrossBuildingArea = r.GrossBuildingArea,
                                     HasParking = r.HasParking,
                                     IsHighlighted = a.IsHighlighted,
                                     Latitude = r.Latitude,
                                     Longitude = r.Longitude,
                                     Parish = r.Parish.Description,
                                     ParishID = r.ParishID,
                                     OriginatorAssetID = a.SourceAssetID,
                                     RealEstateStatus = rs.Description,
                                     RealEstateCondition = rc.Description,
                                     RealEstateTipology = rt.Description,
                                     RealEstateType = rType.Description,
                                     Reference = a.Reference,
                                     PreviousPrice = a.PreviousPrice,
                                     ChangedPriceDate = a.PriceChangeDate,
                                     PublishedDate = a.PublishDate,
                                     HitCount = a.HitCount,
                                     EnergyCertificate = r.EnergyCertificateNumber,
                                     EnergyRating = r.RealEstateEnergyCertificate.Description,
                                     MainPhotoId = (photo == null ? 0 : photo.AssetPhotoID),
                                     Address = r.Address,
                                     ZipCode = r.ZipCode,
                                     CPUDocumentId = cpu.AssetDocumentID,
                                     PlantDocumentId = plant.AssetDocumentID
                                 });

            return mergedResults;
        }
        
        
        public List<PopularSearchResponse> GetPopularSearches(PopularSearchRequest request)
        {
            try
            {
                using (var model = new ValueModel())
                {
                    var response = new List<PopularSearchResponse>();

                    IQueryable<PopularSearchView> query = model.PopularSearchView.Where(x => x.LanguageID == request.LanguageID);
                    query = request.DistrictID.HasValue ? query.Where(x => x.DistrictID == request.DistrictID) : query;
                    query = request.CountyID.HasValue ? query.Where(x => x.CountyID == request.CountyID) : query;
                    query = request.RealEstateTypeID.HasValue ? query.Where(x => x.RealEstateTypeID == request.RealEstateTypeID) : query;

                    List<PopularSearchView> results = query.ToList().OrderByDescending(x => x.SearchRank).Take(request.Limit).ToList();
                    if (results.Any())
                    {
                        foreach (PopularSearchView row in results)
                        {
                            response.Add(new PopularSearchResponse
                            {
                                SearchRank = row.SearchRank,
                                DistrictID = row.DistrictID,
                                District = row.District,
                                CountyID = row.CountyID,
                                County = row.County,
                                RealEstateTypeID = row.RealEstateTypeID,
                                RealEstateType = row.RealEstateType
                            });
                        }
                        return response;
                    }
                    return response;
                }
            }
            catch (Exception ex)
            {
                _log.ErrorFormat("An Error Occured : {0} - Inner exception - {1}", ex.Message, ex.InnerException);
                throw;
            }
        }
        
        
        private static byte[] GetImage(int width, int height, string imagePath, bool crop)
        {
            // get original image
            Stream stream = new StreamReader(imagePath).BaseStream;
            Image originalImage = Image.FromStream(stream);
            // process missing width or height calculations for resize
            int resizeWidth = width == 0 ? ImageResizer.calculateImageWidth(originalImage, height) : width;
            int resizeHeight = height == 0 ? ImageResizer.calculateImageHeight(originalImage, width) : height;
            // resize original image with or whithout crop
            Image resizedImage;
            if (crop)
            {
                resizedImage = ImageResizer.Crop(originalImage, resizeWidth, resizeHeight, AnchorPosition.Center);
            }
            else
            {
                resizedImage = ImageResizer.FixedSize(originalImage, resizeWidth, resizeHeight);
            }
            // return new image byte array
            using (var ms = new MemoryStream())
            {
                var imageFormat = System.Drawing.Imaging.ImageFormat.Jpeg;
                resizedImage.Save(ms, imageFormat);
                return ms.ToArray();
            }
        }
        
        
        private static IQueryable<RealEstateSummaryResponse> GetSummaryResults(IQueryable<Asset> assetQuery, IQueryable<RealEstate> realEstateQuery, ValueModel model, int languageId, int imageWidth, int imageHeight)
        {
            IQueryable<RealEstateSummaryResponse> mergedResults;

            mergedResults = (from a in assetQuery
                             join r in realEstateQuery on a.AssetID equals r.AssetID
                             from rt in model.RealEstateTipologyLocalized
                                .Where(x => x.RealEstateTipologyID == r.RealEstateTipologyID && x.LanguageID == languageId)
                                .DefaultIfEmpty()
                             join rs in model.RealEstateStatusLocalized on r.RealEstateStatusID equals rs.RealEstateStatusID
                             join rType in model.RealEstateTypeLocalized on r.RealEstateTypeID equals rType.RealEstateTypeID
                             from photo in model.AssetPhoto
                             .Where(x => x.AssetID == a.AssetID && x.IsActive && x.IsHighlighted)
                             .DefaultIfEmpty()
                             where rs.LanguageID == languageId
                             && rType.LanguageID == languageId
                             select new RealEstateSummaryResponse
                             {
                                 AssetID = a.AssetID,
                                 AssetTypeID = r.RealEstateTypeID,
                                 County = r.County.Description,
                                 CurrentPrice = a.CurrentPrice,
                                 District = r.District.Description,
                                 GrossBuildingArea = r.GrossBuildingArea,
                                 Parish = r.Parish.Description,
                                 RealEstateStatus = rs.Description,
                                 RealEstateTipology = rt.Description,
                                 RealEstateType = rType.Description,
                                 PreviousPrice = a.PreviousPrice,
                                 MainPhotoId = (photo == null ? 0 : photo.AssetPhotoID),
                             });

           
            return mergedResults;
        }
        public JsonResult GetRequests(JQueryDataTableParamModel param)
        {
            JsonResult jsonResult = null;

            try
            {
                var searchModel = GetSearchCriteria();
                searchModel.PageSize = param.length;
                searchModel.PageNumber = (param.start / param.length) + 1;
                searchModel.AllFields = param.search.value;

                if (param.filters != null)
                {
                    // Header Filters
                    DateTime? dateTimeNullable = null;
                    short? shortNull = null;
                    int? intNull = null;
                    searchModel.AppraiserCompanyId = string.IsNullOrWhiteSpace(param.filters.CompanyId) ? shortNull : Convert.ToInt16(param.filters.CompanyId);
                    searchModel.AppraiserUserId = string.IsNullOrWhiteSpace(param.filters.AppraiserUser) ? shortNull : Convert.ToInt16(param.filters.AppraiserUser);
                    searchModel.AssetTypeId = string.IsNullOrWhiteSpace(param.filters.GetAssetTypes) ? shortNull : Convert.ToInt16(param.filters.GetAssetTypes);
                    searchModel.MethodId = string.IsNullOrWhiteSpace(param.filters.MethodId) ? shortNull : Convert.ToInt16(param.filters.MethodId);
                    searchModel.RequestDueDate = string.IsNullOrWhiteSpace(param.filters.requestduedate) ? dateTimeNullable : Convert.ToDateTime(param.filters.requestduedate);
                    searchModel.AppraiserDueDate = string.IsNullOrWhiteSpace(param.filters.appraiserduedate) ? dateTimeNullable : Convert.ToDateTime(param.filters.appraiserduedate);
                    searchModel.RequestId = string.IsNullOrWhiteSpace(param.filters.request_id) ? intNull : Convert.ToInt32(param.filters.request_id);
                    searchModel.SourceReference = param.filters.reference;
                    searchModel.StatusId = string.IsNullOrWhiteSpace(param.filters.StatusId) ? shortNull : Convert.ToInt16(param.filters.StatusId);
                    searchModel.TechnicianUserId = string.IsNullOrWhiteSpace(param.filters.TechnicianUser) ? shortNull : Convert.ToInt16(param.filters.TechnicianUser);
                    searchModel.CountyId = string.IsNullOrWhiteSpace(param.filters.countyid) ? shortNull : Convert.ToInt16(param.filters.countyid);


                    if (param.filters.GoalCompletionStatus != null)
                    {
                        switch (param.filters.GoalCompletionStatus)
                        {
                            case Models.GoalCompletionStatus.OnTrack:
                                {
                                    searchModel.GoalCompletionStatus = Domain.Models.Valuations.Enums.GoalCompletionStatus.OnTrack;
                                    break;
                                }
                            case Models.GoalCompletionStatus.Behind:
                                {
                                    searchModel.GoalCompletionStatus = Domain.Models.Valuations.Enums.GoalCompletionStatus.Behind;
                                    break;
                                }
                            case Models.GoalCompletionStatus.Overdue:
                                {
                                    searchModel.GoalCompletionStatus = Domain.Models.Valuations.Enums.GoalCompletionStatus.Overdue;
                                    break;
                                }
                            case Models.GoalCompletionStatus.Complete:
                                {
                                    searchModel.GoalCompletionStatus = Domain.Models.Valuations.Enums.GoalCompletionStatus.Complete;
                                    break;
                                }
                        }
                    }

                    // Advanced Search
                    searchModel.SourceReferenceAdvanced = param.filters.ReferenceAdv;
                    searchModel.AppraiserCompanyIds = (param.filters.CompanyIdList != null && !string.IsNullOrWhiteSpace(param.filters.CompanyIdList.FirstOrDefault())) ? param.filters.CompanyIdList.Select(x => short.Parse(x)).ToArray() : null;
                    searchModel.AppraiserUserIds = (param.filters.AppraiserUserList != null && !string.IsNullOrWhiteSpace(param.filters.AppraiserUserList.FirstOrDefault())) ? param.filters.AppraiserUserList.Select(x => short.Parse(x)).ToArray() : null;
                    searchModel.AssetSubTypeIds = (param.filters.AssetSubTypesList != null && !string.IsNullOrWhiteSpace(param.filters.AssetSubTypesList.FirstOrDefault())) ? param.filters.AssetSubTypesList.Select(x => short.Parse(x)).ToArray() : null;
                    searchModel.AssetTypeIds = (param.filters.GetAssetTypesList != null && !string.IsNullOrWhiteSpace(param.filters.GetAssetTypesList.FirstOrDefault())) ? param.filters.GetAssetTypesList.Select(x => short.Parse(x)).ToArray() : null;
                    searchModel.MethodIds = (param.filters.MethodIdList != null && !string.IsNullOrWhiteSpace(param.filters.MethodIdList.FirstOrDefault())) ? param.filters.MethodIdList.Select(x => short.Parse(x)).ToArray() : null;
                    searchModel.StatusIds = (param.filters.StatusIdList != null && !string.IsNullOrWhiteSpace(param.filters.StatusIdList.FirstOrDefault())) ? param.filters.StatusIdList.Select(x => short.Parse(x)).ToArray() : null;
                    searchModel.TechnicianUserIds = (param.filters.TechnicianUserList != null && !string.IsNullOrWhiteSpace(param.filters.TechnicianUserList.FirstOrDefault())) ? param.filters.TechnicianUserList.Select(x => short.Parse(x)).ToArray() : null;
                    searchModel.AppraiserDueDateMin = string.IsNullOrWhiteSpace(param.filters.MinApprduedate) ? dateTimeNullable : Convert.ToDateTime(param.filters.MinApprduedate);
                    searchModel.AppraiserDueDateMax = string.IsNullOrWhiteSpace(param.filters.MaxApprduedate) ? dateTimeNullable : Convert.ToDateTime(param.filters.MaxApprduedate);
                    searchModel.CreationDateMin = string.IsNullOrWhiteSpace(param.filters.MinRequestcreatedate) ? dateTimeNullable : Convert.ToDateTime(param.filters.MinRequestcreatedate);
                    searchModel.CreationDateMax = string.IsNullOrWhiteSpace(param.filters.MaxRequestcreatedate) ? dateTimeNullable : Convert.ToDateTime(param.filters.MaxRequestcreatedate);
                    searchModel.RequestDueDateMin = string.IsNullOrWhiteSpace(param.filters.MinRequestduedate) ? dateTimeNullable : Convert.ToDateTime(param.filters.MinRequestduedate);
                    searchModel.RequestDueDateMax = string.IsNullOrWhiteSpace(param.filters.MaxRequestduedate) ? dateTimeNullable : Convert.ToDateTime(param.filters.MaxRequestduedate);
                    searchModel.CountyIds = (param.filters.CountyIdList != null && !string.IsNullOrWhiteSpace(param.filters.CountyIdList.FirstOrDefault())) ? param.filters.CountyIdList.Select(x => short.Parse(x)).ToArray() : null;
                    searchModel.RequesterUserIds = (param.filters.RequestersList != null && !string.IsNullOrWhiteSpace(param.filters.RequestersList.FirstOrDefault())) ? param.filters.RequestersList.Select(x => short.Parse(x)).ToArray() : null;
                    searchModel.TeamIds = (param.filters.TeamsList != null && !string.IsNullOrWhiteSpace(param.filters.TeamsList.FirstOrDefault())) ? param.filters.TeamsList.Select(x => short.Parse(x)).ToArray() : null;
                }

                searchModel.SortBy = new SortBy[param.order.Length];

                if (param.order != null && param.order.Length > 0)
                {
                    SortBy sortBy = new SortBy();

                    for (var i = 0; i < param.order.Length; i++)
                    {
                        switch (param.order[i].column)
                        {
                            case 0:
                                {
                                    sortBy.CollumnName = "RequestId";
                                    sortBy.Direction = param.order[i].dir;
                                    searchModel.SortBy.SetValue(sortBy, i);
                                    break;
                                }
                            case 1:
                                {
                                    sortBy.CollumnName = "SourceReference";
                                    sortBy.Direction = param.order[i].dir;
                                    searchModel.SortBy.SetValue(sortBy, i);
                                    break;
                                }
                            case 2:
                                {
                                    sortBy.CollumnName = "AssetType";
                                    sortBy.Direction = param.order[i].dir;
                                    searchModel.SortBy.SetValue(sortBy, i);
                                    break;
                                }
                            case 3:
                                {
                                    sortBy.CollumnName = "ValuationMethod";
                                    sortBy.Direction = param.order[i].dir;
                                    searchModel.SortBy.SetValue(sortBy, i);
                                    break;
                                }
                            case 4:
                                {
                                    sortBy.CollumnName = "WorkflowStatusName";
                                    sortBy.Direction = param.order[i].dir;
                                    searchModel.SortBy.SetValue(sortBy, i);
                                    break;
                                }
                            case 5:
                                {
                                    sortBy.CollumnName = "RequestDueDate";
                                    sortBy.Direction = param.order[i].dir;
                                    searchModel.SortBy.SetValue(sortBy, i);
                                    break;
                                }
                            case 6:
                                {
                                    sortBy.CollumnName = "TechnicianUserName";
                                    sortBy.Direction = param.order[i].dir;
                                    searchModel.SortBy.SetValue(sortBy, i);
                                    break;
                                }
                            case 7:
                                {
                                    sortBy.CollumnName = "AppraiserUserName";
                                    sortBy.Direction = param.order[i].dir;
                                    searchModel.SortBy.SetValue(sortBy, i);
                                    break;
                                }
                            case 8:
                                {
                                    sortBy.CollumnName = "AppraiserCompanyName";
                                    sortBy.Direction = param.order[i].dir;
                                    searchModel.SortBy.SetValue(sortBy, i);
                                    break;
                                }
                            case 9:
                                {
                                    sortBy.CollumnName = "AppraiserDueDate";
                                    sortBy.Direction = param.order[i].dir;
                                    searchModel.SortBy.SetValue(sortBy, i);
                                    break;
                                }
                            case 10:
                                {
                                    sortBy.CollumnName = "CountyName";
                                    sortBy.Direction = param.order[i].dir;
                                    searchModel.SortBy.SetValue(sortBy, i);
                                    break;
                                }
                        }
                    }
                }

                if (!string.IsNullOrWhiteSpace(SessionManager.Current.AccessToken))
                {
                    var response = RealEstateValuationClient.GetRequests(searchModel, SessionManager.Current.AccessToken);
                    if (response.Success)
                    {
                        //var model = new RequestViewModel { Valuations = response };

                        jsonResult = Json(
                            new JQueryDataTableResultModel<RequestGridResponse>
                            {
                                draw = param.draw,
                                iTotalRecords = response.Response.TotalRows,
                                iTotalDisplayRecords = response.Response.TotalRows,
                                irecordsFiltered = response.Response.TotalRows,
                                aaData = response.Response.Rows
                            }, JsonRequestBehavior.AllowGet
                        );
                    }
                    else
                    {
                        jsonResult = Json(new { Sucess = response.Success, Message = response.Message }, JsonRequestBehavior.AllowGet);
                    }
                }
            }
            catch (Exception ex)
            {
                jsonResult = Json(new { error = string.Format("An Error Occured : {0} - Inner exception - {1}", ex.Message, ex.InnerException) }, JsonRequestBehavior.AllowGet);
            }

            return jsonResult;
        }
        
        

        private SearchFiltersRequest GetSearchCriteria()
        {
            return (Session["SearchCriteria"] != null) ?
                JsonConvert.DeserializeObject<SearchFiltersRequest>(Session["SearchCriteria"].ToString()) :
                new SearchFiltersRequest();
        }

        private IEnumerable<SelectListItem> GetSelectListGoalCompletionStatus()
        {
            var selectList = new List<SelectListItem>();

            var enumValues = Enum.GetValues(typeof(GoalCompletionStatus)) as GoalCompletionStatus[];
            if (enumValues == null)
                return null;

            foreach (var enumValue in enumValues)
            {
                selectList.Add(new SelectListItem
                {
                    Value = enumValue.ToString(),
                    Text = enumValue.ToString()
                });
            }

            return selectList;
        }
        
 public class LookupsApiClient : ILookupsApiClient
    {
      <appSettings>
    <add key="webpages:Version" value="3.0.0.0" />
    <add key="webpages:Enabled" value="false" />
    <add key="ClientValidationEnabled" value="true" />
    <add key="UnobtrusiveJavaScriptEnabled" value="true" />
    <add key="MaxFavorites" value="20" />
    <add key="SiteUrl" value="http://localhost:6984/" />
    <add key="DebugMode" value="true" />
    
    <add key="PhotoAllowedMimeTypes" value="/(\.|\/)(gif|jpe?g|png)$/i" />
    <add key="DocumentAllowedMimeTypes" value="/(\.|\/)(pdf|doc|docx|xls|xlsx)$/i" />
    <add key="PhotoAllowedFileSize" value="3000000" />   <!-- Size: 3000000bytes = 3Mb -->
    <add key="GoogleMapsApiKey" value="AIzaSyDtKn9hHlcrw7UPgKdLczQN_SogxQONqYw" />
    <add key="GoogleAnalyticsTrackingID" value="UA-39562151-3" />
    <add key="AssetApiUrl" value="http://localhost:41202/" />
  </appSettings>
  
        private const string _lookupsController = "Lookups/";
        private readonly string _endpoint = "";

        public LookupsApiClient()
        {
            _endpoint = ConfigurationManager.AppSettings["AssetApiUrl"];
        }
        
        GeneralResponse<IDictionary<int, string>> ILookupsApiClient.GetActives(string token)
        {
            return GetLookupForMethodDictionay("GetActives", token);
        }
        
        private GeneralResponse<IDictionary<int, string>> GetLookupForMethodDictionay(string methodName, string token)
        {
            var param = new GeneralRequest<SearchFiltersRequest>()
            {
                Token = token
            };

            using (var httpClient = new HttpClient())
            {
                var endpoint = new StringBuilder().Append(_endpoint).Append(_lookupsController).Append(methodName).ToString();
                var response = httpClient.PostAsJsonAsync(endpoint, param).Result;
                return JsonConvert.DeserializeObject<GeneralResponse<IDictionary<int, string>>>(response.Content.ReadAsStringAsync().Result);
            }
        }
        
        GeneralResponse<ActivityHistoryResponse[]> IRealEstateValuationApiClient.GetActivityHistories(long requestId, string token)
        {
            var param = new GeneralRequest<long>()
            {
                Request = requestId,
                Token = token
            };

            using (var httpClient = new HttpClient())
            {
                var result = new GeneralResponse<ActivityHistoryResponse[]>();
                var endpoint = new StringBuilder().Append(_endpoint).Append(_realEstateController).Append("GetActivityHistories").ToString();
                var response = httpClient.PostAsJsonAsync(endpoint, param).Result;
                result = JsonConvert.DeserializeObject<GeneralResponse<ActivityHistoryResponse[]>>(response.Content.ReadAsStringAsync().Result);
                if (!result.Success)
                {
                    result.Response = null;
                }

                return result;
            }
        }
     }
